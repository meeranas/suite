server {
listen 80                 ;
server_name localhost     ;
root /var/www/html/public ;

add_header X-Frame-Options "SAMEORIGIN";
add_header X-Content-Type-Options "nosniff";

# Check for React app index.html first, then Laravel index.php
index index.html index.php ;

charset utf-8 ;

# API routes should always go to Laravel (highest priority)
location /api {
try_files $uri /index.php?$query_string ;
}

# PHP files go to Laravel
location ~ \.php$ {
fastcgi_pass 127.0.0.1:9000                                      ;
fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name ;
include fastcgi_params                                           ;
}

# Static assets (images, CSS, JS from build)
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
expires 1y                                                            ;
add_header Cache-Control "public, immutable";
try_files $uri =404                                                   ;
}

# Laravel-specific routes (if you want to keep them separate from React)
location ~ ^/(login|users|organizations|contacts|reports|img) {
try_files $uri /index.php?$query_string                         ;
}

location = /favicon.ico { access_log off ; log_not_found off; }
location = /robots.txt { access_log off  ; log_not_found off; }

# Serve React app for all other routes (SPA routing) - PRODUCTION ONLY
location / {
# First try the actual file, then directory, then React app index.html
# Only fall back to Laravel if React app doesn't exist
try_files $uri $uri/ /index.html ;
}

error_page 404 /index.html ;

location ~ /\.(?!well-known).* {
deny all                         ;
}
}
