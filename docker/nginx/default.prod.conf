server {
listen 80                 ;
server_name localhost     ;
root /var/www/html/public ;

add_header X-Frame-Options "SAMEORIGIN";
add_header X-Content-Type-Options "nosniff";

# React app index.html takes priority
index index.html index.php ;

charset utf-8 ;

# ============================================
# LARAVEL API ROUTES (Backend)
# ============================================
# All /api/* routes go to Laravel
location /api {
try_files $uri /index.php?$query_string ;
}

# Laravel image handling route (if needed)
location /img {
try_files $uri /index.php?$query_string ;
}

# PHP files (Laravel backend)
location ~ \.php$ {
fastcgi_pass 127.0.0.1:9000                                      ;
fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name ;
include fastcgi_params                                           ;
}

# ============================================
# REACT APP (Frontend)
# ============================================
# Static assets from React build (CSS, JS, images, fonts)
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|map)$ {
expires 1y                                                                ;
add_header Cache-Control "public, immutable";
try_files $uri =404                                                       ;
}

# Favicon and robots.txt
location = /favicon.ico { access_log off ; log_not_found off; }
location = /robots.txt { access_log off  ; log_not_found off; }

# Serve React app for ALL other routes (SPA routing)
# This catches everything not matched above (/, /login, /dashboard, etc.)
location / {
# Try actual file first, then directory, then React app's index.html
try_files $uri $uri/ /index.html ;
}

# React app handles 404s (for client-side routing)
error_page 404 /index.html ;

# Security: deny access to hidden files
location ~ /\.(?!well-known).* {
deny all                         ;
}
}
