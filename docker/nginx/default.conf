server {
listen 80                 ;
server_name localhost     ;
root /var/www/html/public ;

add_header X-Frame-Options "SAMEORIGIN";
add_header X-Content-Type-Options "nosniff";

index index.html index.php ;

charset utf-8 ;

# API routes - always go to Laravel
location /api {
try_files $uri $uri/ /index.php?$query_string ;
}

# Laravel admin routes (Vue.js/Inertia backend) - go to Laravel
# These are the old Ping CRM routes that should still work
location ~ ^/(users|organizations|contacts|reports|img|logout) {
try_files $uri $uri/ /index.php?$query_string                    ;
}

# React frontend (AI Control Hub) - serve the app directory
location /react/ {
    alias /var/www/html/public/react/;
    try_files $uri $uri/ @react_index;
    index index.html;
}

# Serve React index.html
location @react_index {
    root /var/www/html/public;
    rewrite ^.*$ /react/index.html last;
}

# React app static assets
location /assets/ {
alias /var/www/html/public/react/assets/      ;
expires 1y                                    ;
add_header Cache-Control "public, immutable";
access_log off                                ;
}

# React app routes - serve index.html for SPA routing
# This catches all routes not matched by Laravel routes above
location / {
# Try to serve file, if not found serve React app index.html
try_files $uri $uri/ /react/index.html ;
}

location = /favicon.ico { access_log off ; log_not_found off; }
location = /robots.txt { access_log off  ; log_not_found off; }

# error_page 404 /react/index.html ;

location ~ \.php$ {
fastcgi_pass 127.0.0.1:9000                                      ;
fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name ;
include fastcgi_params                                           ;
}

location ~ /\.(?!well-known).* {
deny all                         ;
}
}
