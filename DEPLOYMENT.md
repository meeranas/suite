# AI Suite - Deployment Guide

This guide will help you deploy the AI Suite application to your production server using Docker.

## Prerequisites

- **Server**: Ubuntu 20.04+ or similar Linux distribution
- **Docker**: Version 20.10+
- **Docker Compose**: Version 2.0+
- **Minimum Resources**:
  - CPU: 2 cores
  - RAM: 4GB (8GB recommended)
  - Storage: 20GB+ (more for file storage)

## Quick Start

### 1. Clone the Repository

```bash
git clone <your-repo-url> ai-suite
cd ai-suite
```

### 2. Configure Environment

```bash
# Copy example environment file
cp .env.example .env

# Edit .env file with your configuration
nano .env
```

**Important variables to set:**
- `APP_KEY`: Will be auto-generated by deploy script
- `APP_URL`: Your domain URL (e.g., `https://yourdomain.com`)
- `DB_PASSWORD`: Strong password for PostgreSQL
- `REDIS_PASSWORD`: Optional Redis password
- `OPENAI_API_KEY`: Your OpenAI API key
- `ENCRYPTION_KEY`: Key for encrypting API keys (generate with: `openssl rand -base64 32`)
- Other API keys as needed

### 3. Run Deployment Script

```bash
# Make deploy script executable
chmod +x deploy.sh

# Run deployment
./deploy.sh
```

The script will:
- Check Docker installation
- Generate APP_KEY if needed
- Pull Docker images
- Build application
- Start all services
- Run database migrations
- Optimize Laravel
- Set proper permissions

## Manual Deployment

If you prefer to deploy manually:

### 1. Build and Start Services

```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

### 2. Generate Application Key

```bash
docker-compose -f docker-compose.prod.yml exec app php artisan key:generate
```

### 3. Run Migrations

```bash
docker-compose -f docker-compose.prod.yml exec app php artisan migrate --force
```

### 4. Optimize Application

```bash
docker-compose -f docker-compose.prod.yml exec app php artisan config:cache
docker-compose -f docker-compose.prod.yml exec app php artisan route:cache
docker-compose -f docker-compose.prod.yml exec app php artisan view:cache
```

### 5. Set Permissions

```bash
docker-compose -f docker-compose.prod.yml exec app chown -R www-data:www-data storage bootstrap/cache
docker-compose -f docker-compose.prod.yml exec app chmod -R 775 storage bootstrap/cache
```

## Reverse Proxy Setup (Nginx)

Create an Nginx configuration file at `/etc/nginx/sites-available/ai-suite`:

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Increase upload size for file uploads
    client_max_body_size 100M;

    location / {
        proxy_pass http://localhost:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

Enable the site:

```bash
sudo ln -s /etc/nginx/sites-available/ai-suite /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## SSL Certificate (Let's Encrypt)

```bash
# Install Certbot
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# Auto-renewal (already configured by certbot)
sudo certbot renew --dry-run
```

## Firewall Configuration

```bash
# Allow SSH
sudo ufw allow 22/tcp

# Allow HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw enable
```

## Monitoring and Maintenance

### View Logs

```bash
# All services
docker-compose -f docker-compose.prod.yml logs -f

# Specific service
docker-compose -f docker-compose.prod.yml logs -f app
docker-compose -f docker-compose.prod.yml logs -f db
```

### Backup Database

```bash
# Create backup
docker-compose -f docker-compose.prod.yml exec db pg_dump -U ai_suite_user ai_suite > backup_$(date +%Y%m%d_%H%M%S).sql

# Restore backup
docker-compose -f docker-compose.prod.yml exec -T db psql -U ai_suite_user ai_suite < backup_file.sql
```

### Update Application

```bash
# Pull latest code
git pull origin main

# Rebuild and restart
docker-compose -f docker-compose.prod.yml up -d --build

# Run migrations if needed
docker-compose -f docker-compose.prod.yml exec app php artisan migrate --force

# Clear caches
docker-compose -f docker-compose.prod.yml exec app php artisan cache:clear
docker-compose -f docker-compose.prod.yml exec app php artisan config:clear
docker-compose -f docker-compose.prod.yml exec app php artisan route:clear
docker-compose -f docker-compose.prod.yml exec app php artisan view:clear

# Re-optimize
docker-compose -f docker-compose.prod.yml exec app php artisan config:cache
docker-compose -f docker-compose.prod.yml exec app php artisan route:cache
docker-compose -f docker-compose.prod.yml exec app php artisan view:cache
```

### Run Artisan Commands

```bash
# General artisan commands
docker-compose -f docker-compose.prod.yml exec app php artisan <command>

# Examples:
docker-compose -f docker-compose.prod.yml exec app php artisan tinker
docker-compose -f docker-compose.prod.yml exec app php artisan queue:work
docker-compose -f docker-compose.prod.yml exec app php artisan schedule:run
```

## Scheduled Tasks (Cron)

Add to your server's crontab:

```bash
# Edit crontab
crontab -e

# Add Laravel scheduler (runs every minute)
* * * * * cd /path/to/ai-suite && docker-compose -f docker-compose.prod.yml exec -T app php artisan schedule:run >> /dev/null 2>&1
```

## Troubleshooting

### Services won't start

```bash
# Check logs
docker-compose -f docker-compose.prod.yml logs

# Check service status
docker-compose -f docker-compose.prod.yml ps

# Restart services
docker-compose -f docker-compose.prod.yml restart
```

### Database connection issues

```bash
# Check database is running
docker-compose -f docker-compose.prod.yml ps db

# Test connection
docker-compose -f docker-compose.prod.yml exec app php artisan tinker
# Then in tinker: DB::connection()->getPdo();
```

### Permission issues

```bash
# Fix storage permissions
docker-compose -f docker-compose.prod.yml exec app chown -R www-data:www-data storage bootstrap/cache
docker-compose -f docker-compose.prod.yml exec app chmod -R 775 storage bootstrap/cache
```

### Clear all caches

```bash
docker-compose -f docker-compose.prod.yml exec app php artisan optimize:clear
```

## Production Checklist

- [ ] Set `APP_ENV=production` in `.env`
- [ ] Set `APP_DEBUG=false` in `.env`
- [ ] Configure strong `DB_PASSWORD`
- [ ] Set `APP_URL` to your actual domain
- [ ] Configure SSL certificate
- [ ] Set up firewall rules
- [ ] Configure backup strategy
- [ ] Set up monitoring/logging
- [ ] Configure email settings
- [ ] Test all API integrations
- [ ] Set up scheduled tasks (cron)
- [ ] Review security settings

## Support

For issues or questions, please check:
- Application logs: `docker-compose -f docker-compose.prod.yml logs -f app`
- Laravel logs: `storage/logs/laravel.log`
- Docker logs: `docker-compose -f docker-compose.prod.yml logs`

